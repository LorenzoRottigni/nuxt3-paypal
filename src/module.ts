import { defineNuxtModule, addPlugin, createResolver, addComponent, addTypeTemplate, addImports } from '@nuxt/kit'
import type { PayPalButtonsComponentOptions, PayPalScriptOptions } from '@paypal/paypal-js'

export interface ModuleOptions {
  options: PayPalScriptOptions
  buttons: PayPalButtonsComponentOptions[]
}

export default defineNuxtModule<ModuleOptions>({
  meta: {
    name: 'nuxt3-paypal',
    configKey: 'paypal',
  },
  defaults: {
    options: {
      clientId: '',
    },
    buttons: [
      { fundingSource: 'paypal' },
      { fundingSource: 'paylater' },
    ],
  },
  setup(options, nuxt) {
    nuxt.options.runtimeConfig.public.paypal = options
    const resolver = createResolver(import.meta.url)

    addPlugin(resolver.resolve('./runtime/plugin.client'))

    addComponent({
      name: 'PaypalCheckout',
      filePath: resolver.resolve('runtime/components/PaypalCheckout.vue'),
    })

    addComponent({
      name: 'PaypalButton',
      filePath: resolver.resolve('runtime/components/PaypalButton.vue'),
    })

    addTypeTemplate({
      filename: 'types/paypal.d.ts',
      getContents: () => `// Generated by paypal
        interface PaypalNitroRules {
          paypal?: ModuleOptions
        }
        declare module 'nitropack' {
          interface NitroRouteRules extends PaypalNitroRules {}
          interface NitroRouteConfig extends PaypalNitroRules {}
        }
        export {}`,
    })

    addImports({
      name: 'usePaypal',
      as: 'usePaypal',
      from: resolver.resolve('runtime/composables/usePaypal'),
    })
  },
})
